services:
  # Revolt Mono-App: All-in-one backend and gateway
  revolt-app:
    build:
      context: .
      dockerfile: revolt-app.Dockerfile
    restart: always
    depends_on:
      database:
        condition: service_healthy
      redis:
        condition: service_started
      rabbit:
        condition: service_healthy
      minio:
        condition: service_started
    environment:
      - RAILWAY_PUBLIC_DOMAIN=${RAILWAY_PUBLIC_DOMAIN:-localhost}
      - VAPID_PRIVATE_KEY=${VAPID_PRIVATE_KEY}
      - VAPID_PUBLIC_KEY=${VAPID_PUBLIC_KEY}
      - FILES_ENCRYPTION_KEY=${FILES_ENCRYPTION_KEY}
      - RABBIT_USER=${RABBIT_USER:-rabbituser}
      - RABBIT_PASS=${RABBIT_PASS:-rabbitpass}
      - MINIO_USER=${MINIO_USER:-minioautumn}
      - MINIO_PASS=${MINIO_PASS:-minioautumn}
    volumes:
      - revolt_data:/data
    ports:
      - "${PORT:-80}:${PORT:-80}"

  # MongoDB: Database
  database:
    image: docker.io/mongo
    restart: always
    volumes:
      - mongodb_data:/data/db
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 10s

  # Redis: Event message broker & KV store
  redis:
    image: docker.io/eqalpha/keydb
    restart: always
    volumes:
      - redis_data:/data

  # RabbitMQ: Internal message broker
  rabbit:
    image: docker.io/rabbitmq:4
    restart: always
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBIT_USER:-rabbituser}
      RABBITMQ_DEFAULT_PASS: ${RABBIT_PASS:-rabbitpass}
    volumes:
      - rabbit_data:/var/lib/rabbitmq
    healthcheck:
      test: rabbitmq-diagnostics -q ping
      interval: 10s
      timeout: 10s
      retries: 3
      start_period: 20s

  # MinIO: S3-compatible storage server
  minio:
    image: docker.io/minio/minio
    command: server /data
    volumes:
      - minio_data:/data
    environment:
      MINIO_ROOT_USER: ${MINIO_USER:-minioautumn}
      MINIO_ROOT_PASSWORD: ${MINIO_PASS:-minioautumn}
      MINIO_DOMAIN: minio
    restart: always

volumes:
  revolt_data:
  mongodb_data:
  redis_data:
  rabbit_data:
  minio_data:
